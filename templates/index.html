<script>
    let chatWindow = null;
    let retryCount = 0;

    function openChat() {
        chatWindow = window.open('/chatgpt-proxy', 'chatWindow', 'width=1200,height=800');
        
        // Nouveau syst√®me de v√©rification
        const connectionCheck = setInterval(async () => {
            try {
                await fetch('/chatgpt-proxy/health-check', {
                    method: 'HEAD',
                    timeout: 5000
                });
                document.getElementById("status").innerHTML = "‚úÖ Connexion active";
                retryCount = 0;
            } catch(e) {
                retryCount++;
                document.getElementById("status").innerHTML = 
                    `‚ùå Probl√®me de connexion (tentative ${retryCount}/3)...`;
                
                if(retryCount >= 3) {
                    clearInterval(connectionCheck);
                    chatWindow.close();
                    document.getElementById("status").innerHTML = 
                        "üö® √âchec de connexion - R√©essayez plus tard";
                }
            }
        }, 2000);
    }

    // Nouveau syst√®me de timeout
    function processAndSend() {
        const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error("Timeout apr√®s 15s")), 15000));

        Promise.race([
            processAndSendLogic(),
            timeoutPromise
        ]).catch(error => {
            document.getElementById("chatResponse").value = 
                "‚ö†Ô∏è D√©lai d'attente d√©pass√© - V√©rifiez votre connexion";
        });
    }
</script>
